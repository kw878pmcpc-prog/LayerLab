<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LayerLab ‚Äî Smarter fragrance layering, made simple.</title>
<style>
:root { --bg:#0b0e14; --fg:#e6e6e6; --muted:#aaa; --card:#141925; --accent:#8ac8ff; --accent2:#ffd08a; --border:#263042; }
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,sans-serif}
.app-header{text-align:center;padding:2rem 1rem;border-bottom:1px solid var(--border)}
.tagline{color:var(--muted)}
.container{max-width:1000px;margin:2rem auto;padding:0 1rem}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1rem;margin-bottom:1rem}
h2{margin-top:0}
label{display:block;margin:.5rem 0 .25rem;font-size:.95rem}
input,textarea{width:100%;padding:.6rem .75rem;border-radius:10px;border:1px solid var(--border);background:#0f1420;color:var(--fg)}
button{margin-top:.8rem;padding:.6rem 1.1rem;border:none;border-radius:10px;background:var(--accent);color:#000;font-weight:700;cursor:pointer}
.row{display:flex;gap:.6rem;flex-wrap:wrap}.row>*{flex:1}
#library,#results,#comboResults{margin-top:1rem}
.fragrance{border:1px solid var(--border);border-radius:10px;padding:.6rem .75rem;margin:.4rem 0;background:#0f1420}
.result{border:1px solid var(--border);border-radius:10px;padding:.8rem;margin-top:.6rem;background:#0f1420}
small.muted{color:var(--muted)}
.app-footer{text-align:center;padding:1rem;color:var(--muted);border-top:1px solid var(--border)}
input[type=file]{background:#0f1420;padding:.6rem;border-radius:10px;border:1px solid var(--border);color:var(--fg)}
.badge{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:.15rem .5rem;margin-right:.3rem;font-size:.8rem;color:var(--muted)}
.score{font-weight:900;font-size:1.4rem;color:var(--accent2)}
.breakdown{font-size:.95rem;color:var(--muted)}
.searchRow{display:flex;gap:.6rem;align-items:center}
.tag{display:inline-block;background:#1a2233;border:1px solid var(--border);padding:.15rem .5rem;border-radius:999px;margin:.15rem .25rem 0 0;font-size:.75rem;color:var(--muted)}
.pill{display:inline-block;background:#0f1420;border:1px solid var(--border);padding:.2rem .5rem;border-radius:6px;margin-left:.5rem;color:#b7e3ff}
.inlineBtn{background:#2a3346;color:#e6e6e6;margin:0 .25rem;border-radius:8px;padding:.45rem .7rem}
</style>
</head>
<body>
  <header class="app-header">
    <h1>LayerLab</h1>
    <p class="tagline">Smarter fragrance layering, made simple.</p>
  </header>

  <main class="container">

    <!-- 1) RATE LAYERING COMBO (searchable dropdowns) -->
    <section class="card">
      <h2>Rate a Layering Combo (2‚Äì4 fragrances)</h2>
      <p class="muted">Type to search by name or brand. Leave any box empty if you‚Äôre only rating 2 or 3.</p>
      <div class="row">
        <div>
          <label>Fragrance 1</label>
          <input id="combo1" list="fragranceList" placeholder="Start typing... (e.g., Amber Horizon)">
        </div>
        <div>
          <label>Fragrance 2</label>
          <input id="combo2" list="fragranceList" placeholder="Start typing... (e.g., Velvet Smoke)">
        </div>
      </div>
      <div class="row">
        <div>
          <label>Fragrance 3 (optional)</label>
          <input id="combo3" list="fragranceList" placeholder="Start typing...">
        </div>
        <div>
          <label>Fragrance 4 (optional)</label>
          <input id="combo4" list="fragranceList" placeholder="Start typing...">
        </div>
      </div>
      <div style="margin-top:.5rem">
        <button id="rateComboBtn">‚ú® Rate Layering Combo</button>
        <button id="clearComboBtn" class="inlineBtn">Clear</button>
      </div>
      <datalist id="fragranceList"></datalist>
      <div id="comboResults"></div>
    </section>

    <!-- 2) ADD A FRAGRANCE -->
    <section class="card">
      <h2>Add a Fragrance</h2>
      <div class="row">
        <label>Name <input id="fName" placeholder="e.g., Amber Horizon" /></label>
        <label>Brand <input id="fBrand" placeholder="e.g., PerfumeHouse" /></label>
      </div>
      <div class="row">
        <label>Top Notes <input id="fTop" placeholder="comma-separated (e.g., bergamot, green tea)" /></label>
        <label>Heart Notes <input id="fHeart" placeholder="e.g., rose, cardamom" /></label>
        <label>Base Notes <input id="fBase" placeholder="e.g., cedar, amber, musk" /></label>
      </div>
      <button id="addBtn">Add to Library</button>
      <small class="muted">Tip: raw notes are auto-mapped to families when recommending or scoring.</small>
    </section>

    <!-- 3) QUICK DISCOVERY -->
    <section class="card">
      <h2>Quick Discovery</h2>
      <button id="randomBtn">üé≤ Generate Random Combo</button>
      <div id="results"></div>
    </section>

    <!-- 4) YOUR LIBRARY + SEARCH -->
    <section class="card">
      <h2>Your Library</h2>
      <div class="searchRow">
        <input id="searchInput" placeholder="Search by name, brand, or note (e.g., bergamot, amber, smoky)..." />
        <button id="clearSearchBtn" class="inlineBtn">Clear</button>
      </div>
      <div id="library"></div>
    </section>

    <!-- 5) CSV IMPORT / EXPORT -->
    <section class="card">
      <h2>Import / Export</h2>
      <div class="row">
        <div>
          <label>Import CSV (Kaggle/Fragrantica styles supported)
            <input id="csvInput" type="file" accept=".csv" />
          </label>
          <small class="muted">
            Works with columns like: <code>Perfume/Name</code>, <code>Brand/Designer</code>, <code>Top Notes</code>, <code>Middle/Heart Notes</code>, <code>Base Notes</code>,
            or a single <code>Notes</code> column containing ‚ÄúTop Notes: ‚Ä¶ | Middle Notes: ‚Ä¶ | Base Notes: ‚Ä¶‚Äù.
          </small>
          <div id="importBadge"></div>
        </div>
        <div>
          <button id="exportBtn">Export Library as CSV</button><br/>
          <small class="muted">Downloads your current library.</small>
        </div>
      </div>
    </section>

    <!-- 6) LEGAL -->
    <section class="card">
      <h2>Data & Legal</h2>
      <p class="muted">
        LayerLab does not scrape third-party sites. Import only data you have rights to use.
      </p>
    </section>

  </main>

  <footer class="app-footer">
    <small>¬© 2025 LayerLab ‚Äî Created by PerfumePeter</small>
  </footer>

<script>
/* =======================
   Sample data (so the app isn't empty)
======================= */
const sampleFragrances = [
  { name:"Amber Horizon", brand:"Aether Co", notes:{ top:["vanilla"], heart:["amber"], base:["woody","resinous"] } },
  { name:"Citrus Veil", brand:"Solaire", notes:{ top:["bergamot","green tea"], heart:["orange blossom"], base:["musk"] } },
  { name:"Velvet Smoke", brand:"NoirWorks", notes:{ top:["black pepper"], heart:["smoke"], base:["amber","cedar"] } },
  { name:"Ocean Muse", brand:"BlueNote", notes:{ top:["sea notes","green"], heart:["herbal","aromatic"], base:["musk"] } },
  { name:"Rose Ember", brand:"Lumine", notes:{ top:["rose"], heart:["cardamom"], base:["amber","tonka bean"] } },
];

/* =======================
   Note ‚Üí family mapper
======================= */
const MAP = {
  // citrus
  "bergamot":"citrus","lemon":"citrus","lime":"citrus","grapefruit":"citrus","orange":"citrus","mandarin":"citrus","petitgrain":"citrus",
  // green/fresh/herbal/aromatic
  "green tea":"green","violet leaf":"green","galbanum":"green","basil":"herbal","mint":"herbal","rosemary":"aromatic","sage":"herbal","green":"green",
  // florals
  "rose":"floral","jasmine":"white_floral","tuberose":"white_floral","orange blossom":"white_floral","ylang-ylang":"floral","lily":"floral","white floral":"white_floral",
  // spicy
  "cardamom":"spicy","black pepper":"spicy","pink pepper":"spicy","cinnamon":"spicy","clove":"spicy","nutmeg":"spicy","pepper":"spicy","spicy":"spicy",
  // woods/resins/smoke
  "cedar":"woody","sandalwood":"woody","vetiver":"woody","oud":"woody","incense":"smoky","smoke":"smoky","myrrh":"resinous","labdanum":"resinous","frankincense":"resinous","resin":"resinous",
  // amber/musk/sweet/gourmand
  "amber":"amber","ambroxan":"amber","musk":"musky","tonka bean":"sweet","vanilla":"sweet","caramel":"gourmand","chocolate":"gourmand","praline":"gourmand","honey":"sweet",
  // aquatic/aldehydic
  "sea notes":"aquatic","marine":"aquatic","aldehydes":"aldehydic"
};
const FAMILIES = ["citrus","green","white_floral","floral","spicy","resinous","smoky","woody","musky","amber","sweet","gourmand","aquatic","aldehydic","herbal","aromatic"];

/* Similarity matrix (rough heuristics) */
const SIM = (() => {
  const n = FAMILIES.length, M = Array.from({length:n},()=>Array(n).fill(0));
  for (let i=0;i<n;i++) M[i][i]=1;
  const s=(a,b,v)=>{ const i=FAMILIES.indexOf(a), j=FAMILIES.indexOf(b); if(i>=0&&j>=0){ M[i][j]=v; M[j][i]=v; } };
  s("woody","smoky",0.6); s("woody","resinous",0.5); s("amber","sweet",0.55); s("amber","gourmand",0.45);
  s("white_floral","floral",0.7); s("citrus","green",0.6); s("herbal","aromatic",0.7); s("musky","amber",0.5);
  s("smoky","sweet",0.35); s("smoky","gourmand",0.3); s("citrus","amber",0.25); s("green","sweet",0.2); s("citrus","woody",0.3);
  s("aldehydic","gourmand",-0.3); s("aldehydic","smoky",-0.25); s("aquatic","smoky",-0.25); s("aquatic","gourmand",-0.2); s("green","gourmand",-0.15);
  return M;
})();

/* =======================
   State & Storage
======================= */
let library = JSON.parse(localStorage.getItem("layerlab_lib") || "[]");
if (!library.length) library = sampleFragrances.slice();
function save(){ localStorage.setItem("layerlab_lib", JSON.stringify(library)); }

/* =======================
   Utils
======================= */
const escapeHtml = (s="") => s.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));
const lowerIncludes = (hay="", needle="") => hay.toLowerCase().includes(needle.toLowerCase());
const splitNotes = s => (s||"").split(/[|/;,]+/).map(x=>x.replace(/[\[\]"‚Äú‚Äù'()]/g,"").trim()).filter(Boolean);
const clamp01 = x => Math.max(0, Math.min(1, x));
const dot = (a,b)=>a.reduce((sum,v,i)=>sum+v*b[i],0);
const norm = a=>Math.sqrt(dot(a,a));
const cosine = (a,b)=>{const na=norm(a), nb=norm(b); return (na===0||nb===0)?0:dot(a,b)/(na*nb);};
function toFamilies(noteList){ return noteList.map(n=>n.toLowerCase().trim()).filter(Boolean).map(n => MAP[n] || n); }
function accordVector(fr){
  const vec = Array(FAMILIES.length).fill(0);
  const push = (arr, w)=> arr.forEach(n=>{
    const fam = MAP[n.toLowerCase()] || n.toLowerCase();
    const idx = FAMILIES.indexOf(fam);
    if (idx>=0) vec[idx] += w;
  });
  push(fr.notes.top||[], 1.0);
  push(fr.notes.heart||[], 1.5);
  push(fr.notes.base||[], 2.0);
  const maxv = Math.max(1, ...vec);
  return vec.map(v=>v/maxv);
}
const fullKey = f => `${f.name} ‚Äî ${f.brand}`.trim();

/* =======================
   Rendering (search + library + datalist)
======================= */
let searchTerm = "";
document.getElementById("searchInput")?.addEventListener("input", (e)=>{ searchTerm = e.target.value.trim(); renderLibrary(); });
document.getElementById("clearSearchBtn")?.addEventListener("click", ()=>{ searchTerm=""; const si=document.getElementById("searchInput"); if(si){si.value="";} renderLibrary(); });

function filterBySearch(list){
  if (!searchTerm) return list;
  const q = searchTerm.toLowerCase();
  return list.filter(f => {
    const inName = lowerIncludes(f.name, q);
    const inBrand = lowerIncludes(f.brand, q);
    const inNotes = [...(f.notes.top||[]), ...(f.notes.heart||[]), ...(f.notes.base||[])]
      .some(n => n.toLowerCase().includes(q) || (MAP[n.toLowerCase()]||"").includes(q));
    return inName || inBrand || inNotes;
  });
}

function renderLibrary(){
  const div = document.getElementById("library");
  if (!div) return;
  div.innerHTML = "";
  filterBySearch(library).forEach((f)=>{
    const el = document.createElement("div");
    el.className = "fragrance";
    const famTop = toFamilies(f.notes.top||[]);
    const famHeart= toFamilies(f.notes.heart||[]);
    const famBase= toFamilies(f.notes.base||[]);
    el.innerHTML = `
      <strong>${escapeHtml(f.name)}</strong> <span style="opacity:.8">(${escapeHtml(f.brand)})</span><br/>
      <small>Top:</small> ${(f.notes.top||[]).join(", ") || "‚Äî"}<br/>
      <small>Heart:</small> ${(f.notes.heart||[]).join(", ") || "‚Äî"}<br/>
      <small>Base:</small> ${(f.notes.base||[]).join(", ") || "‚Äî"}<br/>
      ${[...new Set([...famTop, ...famHeart, ...famBase].filter(x=>FAMILIES.includes(x)))].map(fm=>`<span class="tag">${fm}</span>`).join(" ")}
    `;
    div.appendChild(el);
  });
}

function renderDatalist(){
  const dl = document.getElementById("fragranceList");
  if (!dl) return;
  dl.innerHTML = "";
  library.forEach(f=>{
    const opt = document.createElement("option");
    opt.value = fullKey(f);
    dl.appendChild(opt);
  });
}

/* =======================
   Actions
======================= */
document.getElementById("addBtn").onclick = ()=>{
  const f = {
    name: document.getElementById("fName").value.trim() || "Untitled",
    brand: document.getElementById("fBrand").value.trim(),
    notes:{
      top:  splitNotes(document.getElementById("fTop").value),
      heart:splitNotes(document.getElementById("fHeart").value),
      base: splitNotes(document.getElementById("fBase").value)
    }
  };
  library.push(f); save(); renderLibrary(); renderDatalist();
  ["fName","fBrand","fTop","fHeart","fBase"].forEach(id=>document.getElementById(id).value="");
};

// Random combo
document.getElementById("randomBtn").onclick = ()=>{
  if (library.length<2) return alert("Add at least 2 fragrances");
  const i = Math.floor(Math.random()*library.length); let j=i; while(j===i) j=Math.floor(Math.random()*library.length);
  const A=library[i], B=library[j]; const shared = sharedFamilies(A,B);
  document.getElementById("results").innerHTML = `
    <div class="result"><strong>${escapeHtml(A.name)}</strong> + <strong>${escapeHtml(B.name)}</strong><br/>
    ${shared.length ? `Shared families: ${shared.join(", ")}` : "Contrasting but complementary!"}</div>`;
};

// CSV import ‚Äî supports Kaggle/Fragrantica-like schemas
document.getElementById("csvInput").addEventListener("change", async (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  const text = await file.text();
  const rows = text.split(/\r?\n/).filter(r=>r.trim().length);
  if (!rows.length) return alert("CSV is empty");

  const headers = parseCsvLine(rows[0]).map(h=>h.trim());
  const H = headers.map(h => h.toLowerCase());

  const nameIdx = pickOne(H, ["name","perfume","title"]);
  const brandIdx= pickOne(H, ["brand","designer","house"]);
  const topIdx  = pickOne(H, ["top notes","top","top_notes","notes_top","note_top"]);
  const heartIdx= pickOne(H, ["middle notes","heart notes","heart","middle","mid","notes_middle","note_heart","note_mid"]);
  const baseIdx = pickOne(H, ["base notes","base","notes_base","note_base"]);
  const notesIdx= pickOne(H, ["notes","all notes","pyramid","olfactory pyramid"]);

  const badge = document.getElementById("importBadge");
  const found = [];
  if (nameIdx>=0) found.push("name"); if (brandIdx>=0) found.push("brand");
  if (topIdx>=0||heartIdx>=0||baseIdx>=0) found.push("top/middle/base");
  if (notesIdx>=0) found.push("notes");
  badge.innerHTML = `<span class="pill">Detected: ${found.join(", ")||"none"}</span>`;

  if (nameIdx < 0) return alert("Couldn't find a Name/Perfume column.");
  if (brandIdx < 0) return alert("Couldn't find a Brand/Designer column.");

  let imported = 0;
  for (let i=1;i<rows.length;i++){
    const cols = parseCsvLine(rows[i]);
    if (!cols || !cols.length) continue;

    const name  = (cols[nameIdx]  || "").trim(); if (!name) continue;
    const brand = (cols[brandIdx] || "").trim();

    let top=[], heart=[], base=[];
    if (topIdx>=0 || heartIdx>=0 || baseIdx>=0){
      top   = splitNotes(cols[topIdx]   || "");
      heart = splitNotes(cols[heartIdx] || "");
      base  = splitNotes(cols[baseIdx]  || "");
    }
    if ((!top.length && !heart.length && !base.length) && notesIdx>=0){
      const raw = String(cols[notesIdx]||"");
      const parsed = parseCombinedNotes(raw);
      top = parsed.top; heart = parsed.heart; base = parsed.base;
      if (!top.length && !heart.length && !base.length) {
        heart = splitNotes(raw);
      }
    }
    library.push({ name, brand, notes:{ top, heart, base }});
    imported++;
  }
  save(); renderLibrary(); renderDatalist();
  alert(`Imported ${imported} records.`);
});

document.getElementById("exportBtn").onclick = ()=>{
  const rows = [["name","brand","top","heart","base"]];
  library.forEach(f=>rows.push([
    f.name, f.brand, (f.notes.top||[]).join("; "), (f.notes.heart||[]).join("; "), (f.notes.base||[]).join("; ")
  ]));
  const csv = rows.map(r=>r.map(cell=>/[,"]/.test(cell)?('"'+cell.replace(/"/g,'""')+'"'):cell).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"}); const url = URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="layerlab_library.csv"; a.click(); URL.revokeObjectURL(url);
};

function parseCsvLine(line){
  const out=[], re=/\s*(?:"([^"]*)"|([^,]*))\s*(?:,|$)/g; let m;
  while((m=re.exec(line))!==null){ out.push(m[1] ?? m[2]); }
  return out;
}
function pickOne(headersLower, keys){
  for (const k of keys){ const idx = headersLower.indexOf(k); if (idx>=0) return idx; }
  return -1;
}
function parseCombinedNotes(raw){
  const lower = raw.toLowerCase();
  const grab = (label)=> {
    const m = lower.match(new RegExp(label+"\\s*:\\s*([^|/]+)","i")); // up to pipe/slash
    return m ? splitNotes(m[1]) : [];
  };
  let top = grab("top notes?");
  let heart = grab("(middle|heart) notes?");
  let base = grab("base notes?");
  // fallback: look for segments separated by |
  if (!top.length && !heart.length && !base.length){
    const parts = raw.split("|").map(s=>s.trim());
    if (parts.length>=3){ top = splitNotes(parts[0]); heart = splitNotes(parts[1]); base = splitNotes(parts[2]); }
  }
  return { top, heart, base };
}

/* =======================
   Combo Rating with 4 searchables
======================= */
document.getElementById("rateComboBtn").onclick = ()=>{
  const fields = ["combo1","combo2","combo3","combo4"];
  const picks = fields.map(id => document.getElementById(id).value.trim()).filter(Boolean);
  if (picks.length < 2) return alert("Please pick at least 2 fragrances.");
  const selected = [];
  for (const v of picks){
    const idx = findByKey(v);
    if (idx === -1) { alert(`Not found in library: "${v}". Please select from the dropdown suggestions.`); return; }
    selected.push(library[idx]);
  }
  const res = scoreCombo(selected);
  document.getElementById("comboResults").innerHTML = `
    <div class="result">
      <div class="score">Score: ${Math.round(res.total*100)} / 100</div>
      <div class="breakdown">
        Glue (backbone): ${(res.glue*100).toFixed(0)} ¬∑
        Pleasant contrast: ${(res.contrast*100).toFixed(0)} ¬∑
        Temporal harmony: ${(res.temporal*100).toFixed(0)} ¬∑
        Clash penalty: -${(res.clash*100).toFixed(0)}
      </div>
      <div style="margin-top:.5rem">
        ${selected.map(f=>`<span class="badge">${escapeHtml(f.name)}</span>`).join(" ")}
      </div>
    </div>`;
};
document.getElementById("clearComboBtn").onclick = ()=>{
  ["combo1","combo2","combo3","combo4"].forEach(id=>document.getElementById(id).value="");
  document.getElementById("comboResults").innerHTML = "";
};

function findByKey(value){
  // Exact match on "Name ‚Äî Brand"; fallback: match Name only
  const exact = library.findIndex(f => fullKey(f).toLowerCase() === value.toLowerCase());
  if (exact !== -1) return exact;
  const nameOnly = library.findIndex(f => f.name.toLowerCase() === value.toLowerCase());
  return nameOnly;
}

/* =======================
   Scoring (multi 2‚Äì4)
======================= */
function sharedFamilies(A,B){
  const fa = toFamilies([...(A.notes.top||[]),...(A.notes.heart||[]),...(A.notes.base||[])]);
  const fb = toFamilies([...(B.notes.top||[]),...(B.notes.heart||[]),...(B.notes.base||[])]);
  return Array.from(new Set(fa.filter(x=>fb.includes(x) && FAMILIES.includes(x))));
}
function scoreCombo(list){
  const vecs = list.map(accordVector);
  let glue=0, contrast=0, pairs=0, clash=0, temporal=0;
  for (let i=0;i<vecs.length;i++){
    for (let j=i+1;j<vecs.length;j++){
      const a = vecs[i], b = vecs[j];
      const sim = cosine(a,b);
      glue += sim;
      const contr = (1 - sim) * (0.5 + 0.5*sim);
      contrast += contr;
      clash += pairClash(a,b);
      temporal += temporalHarmony(list[i], list[j]);
      pairs++;
    }
  }
  if (pairs>0){ glue/=pairs; contrast/=pairs; clash/=pairs; temporal/=pairs; }
  const w = {glue:.34, contrast:.18, temporal:.28, clash:.20};
  let total = w.glue*glue + w.contrast*contrast + w.temporal*temporal - w.clash*clash;
  total = clamp01(total);
  return { total, glue, contrast, temporal, clash };
}
function pairClash(a,b){
  let c=0;
  for (let i=0;i<FAMILIES.length;i++){
    for (let j=0;j<FAMILIES.length;j++){
      const s = SIM[i][j];
      if (s < 0) c += (a[i]*b[j]) * (-s);
    }
  }
  return clamp01(c/5);
}
function temporalHarmony(frA, frB){
  const famA = familyLayerWeights(frA), famB = familyLayerWeights(frB);
  const baseOverlap = cosine(famA.base, famB.base);
  const heartOverlap = cosine(famA.heart, famB.heart);
  const topOverlap  = cosine(famA.top,  famB.top);
  let t = 0.6*baseOverlap + 0.35*heartOverlap - 0.25*topOverlap;
  t = (t + 0.25);
  return clamp01(t);
}
function familyLayerWeights(fr){
  const mk = ()=>Array(FAMILIES.length).fill(0);
  const top=mk(), heart=mk(), base=mk();
  (fr.notes.top||[]).forEach(n=>{ const fam=MAP[n.toLowerCase()]||n.toLowerCase(); const i=FAMILIES.indexOf(fam); if(i>=0) top[i]+=1; });
  (fr.notes.heart||[]).forEach(n=>{ const fam=MAP[n.toLowerCase()]||n.toLowerCase(); const i=FAMILIES.indexOf(fam); if(i>=0) heart[i]+=1.5; });
  (fr.notes.base||[]).forEach(n=>{ const fam=MAP[n.toLowerCase()]||n.toLowerCase(); const i=FAMILIES.indexOf(fam); if(i>=0) base[i]+=2.0; });
  const normz = v => { const m=Math.max(1,...v); return v.map(x=>x/m); };
  return { top:normz(top), heart:normz(heart), base:normz(base) };
}

/* =======================
   Initial paint
======================= */
renderLibrary();
renderDatalist();
</script>
</body>
</html>
